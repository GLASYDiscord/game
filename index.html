<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±åˆç‰ˆ: 30ã‚²ãƒ¼ãƒ  ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ã‚¿ãƒ«</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* --- CSS ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(44, 62, 80, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            transition: opacity 0.3s;
        }

        #login-overlay h1 { font-size: 2.5em; margin-bottom: 20px; }

        /* èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ  */
        #auth-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            color: #333;
            margin-top: 20px;
        }

        #auth-form input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #auth-form button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #google-login-button { background-color: #4285F4; color: white; margin-top: 15px; }
        #register-login-button { background-color: #2ecc71; color: white; }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (ãƒãƒ¼ã‚¿ãƒ«ã¨ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ã®è¦ªã‚³ãƒ³ãƒ†ãƒŠ) */
        #main-container {
            display: none;
            width: 100%;
            max-width: 1000px;
            opacity: 0;
            transition: opacity 0.5s;
            align-items: center;
            flex-direction: column;
            padding-top: 20px;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .user-controls { display: flex; align-items: center; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ã‚¨ãƒªã‚¢ */
        #game-area {
            display: none; /* ã‚²ãƒ¼ãƒ ä¸­ã¯ãƒãƒ¼ã‚¿ãƒ«ã‚’éš ã™ */
            width: 100%;
            max-width: 600px;
            text-align: center;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* ãƒãƒ¼ã‚¿ãƒ«ã‚¨ãƒªã‚¢ */
        #portal-area {
            display: flex; /* åˆæœŸã¯è¡¨ç¤º */
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        /* ã‚²ãƒ¼ãƒ ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        #game-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            width: 100%;
            margin-bottom: 50px;
        }

        .game-card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none;
            color: #333;
            text-align: center;
        }
        .game-card:hover { transform: translateY(-3px); }
        .game-icon { font-size: 3em; margin-bottom: 5px; }
        .game-name { font-weight: bold; font-size: 0.95em; }
        
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        #ranking-section {
            width: 100%;
            max-width: 400px;
            margin-top: 30px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #bdc3c7;
        }

        /* Game 1 Specific Styles (ã‚¯ãƒªãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸) */
        #click-target {
            background-color: #e74c3c;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 20px auto;
            color: white;
            transition: transform 0.1s;
        }

        #click-target.active { cursor: pointer; }
        #click-target:active { transform: scale(0.95); }
        #game1-start-button { padding: 10px 20px; cursor: pointer; background-color: #2ecc71; color: white; border: none; border-radius: 5px; font-weight: bold; }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="loading-status">ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­...</div>
        
        <div id="login-prompt" style="display:none; color:#ddd;">
            <h1>ğŸ•¹ï¸ 30 Games Project</h1>
            <p style="color:white; margin-top:20px;">ã‚²ãƒ¼ãƒ ã‚’éŠã¶ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ–°è¦ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚</p>
            
            <div id="auth-form">
                <input type="email" id="email-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
                <input type="password" id="password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (6æ–‡å­—ä»¥ä¸Š)" required>
                
                <button id="register-login-button">ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</button>
                <hr style="border-top: 1px solid #ccc; margin: 15px 0;">
                <button id="google-login-button">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>

                <p style="font-size: 0.8em; margin-top: 10px; color:#555;">â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæœªç™»éŒ²ã®å ´åˆã¯è‡ªå‹•çš„ã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚</p>
                <p id="auth-message" style="color:red; font-size:0.9em; margin-top:5px;"></p>
            </div>
        </div>
    </div>

    <div id="main-container">
        
        <header>
            <button id="back-to-portal-button" style="padding: 8px 15px; cursor:pointer; display:none;">
                â† ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã‚‹
            </button>
            <div class="user-controls">
                <span id="user-display" style="font-weight:bold; color:#2c3e50; margin-right:15px;"></span>
                <button id="logout-button" style="padding: 5px 10px; cursor:pointer;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </header>

        <div id="portal-area">
            <h1>ğŸ® 30 ã‚²ãƒ¼ãƒ ãƒãƒ¼ã‚¿ãƒ« ğŸ•¹ï¸</h1>
            <p>éŠã³ãŸã„ã‚²ãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>

            <div id="game-list">
                </div>

            <div id="ranking-section">
                <h2 id="ranking-title">ğŸ† ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° (Game 1: ã‚¯ãƒªãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸)</h2>
                <div id="rankings">
                    <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>

        <div id="game-area">
            <h2 id="game-title"></h2>
            <div id="game-content">
                </div>
        </div>
    </div>

    <script>
        /* --- JavaScript ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã¨Firebaseé€£æº --- */
        
        // --- 1. Firebase è¨­å®šï¼ˆã“ã“ã‚’ã”è‡ªèº«ã®æƒ…å ±ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼‰ ---
        const firebaseConfig = {
            apiKey: "AIzaSyAIMUrhWPj7HDPe4peQMS5Hs5MhiXnug6I",
            authDomain: "gamegame-d619e.firebaseapp.com",
            projectId: "gamegame-d619e",
            storageBucket: "gamegame-d619e.firebasestorage.app",
            messagingSenderId: "22291211960",
            appId: "1:22291211960:web:fdaccb7de4b18e2195b64d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. 30ã‚²ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
        const GAMES = [];
        const ICONS = ['ğŸ–±ï¸', 'ğŸ§©', 'ğŸš€', 'ğŸ', 'ğŸ²', 'ğŸ§ ', 'âš”ï¸', 'ğŸ¯', 'â±ï¸', 'ğŸ¹', 'ğŸ”¦', 'ğŸ¤–', 'ğŸ’°', 'ğŸ—ï¸', 'ğŸ§ª', 'ğŸ”¥', 'ğŸ’§', 'âš¡', 'ğŸŒ²', 'â˜€ï¸', 'ğŸŒ™', 'â­', 'ğŸŒˆ', 'ğŸš²', 'ğŸš—', 'ğŸš¢', 'ğŸ›¸', 'ğŸ”®', 'ğŸ§¸', 'ğŸ””'];
        
        for (let i = 1; i <= 30; i++) {
            const gameNumber = String(i).padStart(3, '0');
            GAMES.push({
                id: i,
                name: `ã‚²ãƒ¼ãƒ  ${i}: ${['ã‚¯ãƒªãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸', 'ãƒ©ãƒ³ãƒ€ãƒ ã‚«ãƒ©ãƒ¼æ¢ã—', 'è¨˜æ†¶åŠ›ãƒ†ã‚¹ãƒˆ', 'åå°„ç¥çµŒã‚²ãƒ¼ãƒ ', 'è¨ˆç®—ã‚¹ãƒ”ãƒ¼ãƒ‰'][i % 5] || 'ä¸€èˆ¬ã‚²ãƒ¼ãƒ '}`,
                icon: ICONS[i - 1],
                collection: `scores_game_${gameNumber}`
            });
        }
        
        let currentRankingCollection = GAMES[0].collection;
        let activeGameId = null;

        // --- 3. DOMè¦ç´  ---
        const loginOverlay = document.getElementById('login-overlay');
        const loadingStatus = document.getElementById('loading-status');
        const loginPrompt = document.getElementById('login-prompt');
        const userDisplay = document.getElementById('user-display');
        const logoutButton = document.getElementById('logout-button');
        const mainContainer = document.getElementById('main-container');
        const gameListElement = document.getElementById('game-list');
        const rankingsElement = document.getElementById('rankings');
        const rankingTitleElement = document.getElementById('ranking-title');
        const authMessage = document.getElementById('auth-message');
        const portalArea = document.getElementById('portal-area');
        const gameArea = document.getElementById('game-area');
        const gameContent = document.getElementById('game-content');
        const gameTitleElement = document.getElementById('game-title');
        const backToPortalButton = document.getElementById('back-to-portal-button');
        
        // èªè¨¼ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ 
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const registerLoginButton = document.getElementById('register-login-button');
        const googleLoginButton = document.getElementById('google-login-button');

        // --- 4. èªè¨¼ (Authentication) é–¢é€£é–¢æ•° ---

        function updateAuthMessage(message, isError = false) {
            authMessage.textContent = message;
            authMessage.style.color = isError ? 'red' : 'green';
        }

        // Googleãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error("Googleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
                updateAuthMessage(`Googleãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${error.message}`, true);
            });
        }

        // ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ ç™»éŒ²ã¾ãŸã¯ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function handleEmailAuth() {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || password.length < 6) {
                updateAuthMessage("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨6æ–‡å­—ä»¥ä¸Šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => { updateAuthMessage("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼", false); })
                .catch(loginError => {
                    if (loginError.code === 'auth/user-not-found') {
                        auth.createUserWithEmailAndPassword(email, password)
                            .then(() => { updateAuthMessage("æ–°è¦ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ğŸ‰", false); })
                            .catch(registerError => {
                                console.error("æ–°è¦ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", registerError);
                                updateAuthMessage(`æ–°è¦ç™»éŒ²å¤±æ•—: ${registerError.message}`, true);
                            });
                    } else {
                        console.error("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", loginError);
                        updateAuthMessage(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${loginError.message}`, true);
                    }
                });
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼çŠ¶æ…‹ã®ç›£è¦– (ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã‚’åˆ¶å¾¡)
        auth.onAuthStateChanged(user => {
            if (user) {
                const displayName = user.displayName || user.email.split('@')[0];
                userDisplay.textContent = `ã‚ˆã†ã“ãã€${displayName} ã•ã‚“`;
                
                loginOverlay.style.opacity = '0';
                setTimeout(() => { loginOverlay.style.display = 'none'; }, 300);
                
                mainContainer.style.display = 'flex';
                setTimeout(() => { mainContainer.style.opacity = '1'; }, 350);

                renderPortal(); // ãƒãƒ¼ã‚¿ãƒ«ã‚’æç”»ã—ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒ­ãƒ¼ãƒ‰
            } else {
                userDisplay.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
                mainContainer.style.display = 'none';
                
                loginOverlay.style.display = 'flex';
                loginOverlay.style.opacity = '1';

                loadingStatus.style.display = 'none';
                loginPrompt.style.display = 'block';
            }
        });

        // --- 5. ãƒãƒ¼ã‚¿ãƒ«æç”»ã¨ã‚²ãƒ¼ãƒ èµ·å‹• ---
        function renderPortal() {
            portalArea.style.display = 'flex';
            gameArea.style.display = 'none';
            backToPortalButton.style.display = 'none';
            activeGameId = null;
            
            renderGameList();
            loadRankings();
        }

        function renderGameList() {
            gameListElement.innerHTML = ''; 
            
            GAMES.forEach(game => {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.innerHTML = `
                    <div class="game-icon">${game.icon}</div>
                    <div class="game-name">${game.name}</div>
                `;
                card.onclick = () => launchGame(game.id);
                gameListElement.appendChild(card);
            });
        }
        
        function launchGame(gameId) {
            const gameData = GAMES.find(g => g.id === gameId);
            if (!gameData) return;
            
            activeGameId = gameId;
            currentRankingCollection = gameData.collection;
            gameTitleElement.textContent = `${gameData.icon} ${gameData.name}`;

            portalArea.style.display = 'none';
            gameArea.style.display = 'block';
            backToPortalButton.style.display = 'inline-block';
            
            // ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æç”»
            renderGameContent(gameId);

            // èµ·å‹•ã—ãŸã‚²ãƒ¼ãƒ ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å†ãƒ­ãƒ¼ãƒ‰
            loadRankings(); 
        }

        function renderGameContent(gameId) {
            // Game 1 ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«ç›´æ¥çµ„ã¿è¾¼ã‚€ (ã‚¯ãƒªãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸)
            if (gameId === 1) {
                gameContent.innerHTML = `
                    <p>æ®‹ã‚Šæ™‚é–“: <span id="game1-timer">10.0</span>ç§’</p>
                    <h2>ã‚¹ã‚³ã‚¢: <span id="game1-score">0</span></h2>
                    <div id="click-target">ã‚¯ãƒªãƒƒã‚¯!</div>
                    <p id="game1-status-message">æº–å‚™å®Œäº†ã€‚ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                    <button id="game1-start-button">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                `;
                // Game 1 ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                setupGame1Logic();

            } else {
                // Game 2 ä»¥é™ã®ãƒ€ãƒŸãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
                gameContent.innerHTML = `
                    <p style="color:red;">ã“ã®ã‚²ãƒ¼ãƒ ï¼ˆGame ${gameId}ï¼‰ã¯ç¾åœ¨é–‹ç™ºä¸­ã§ã™ã€‚</p>
                    <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¯æ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚</p>
                    <button onclick="renderPortal()" style="padding: 10px 20px; margin-top: 20px;">ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã‚‹</button>
                `;
            }
        }
        
        // --- 6. Game 1 (ã‚¯ãƒªãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸) ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        let game1Score = 0;
        let game1TimeLeft = 10;
        let game1IsPlaying = false;
        let game1TimerInterval;
        const TARGET_TIME = 10;

        function setupGame1Logic() {
            const scoreElement = document.getElementById('game1-score');
            const timerElement = document.getElementById('game1-timer');
            const targetElement = document.getElementById('click-target');
            const statusMessageElement = document.getElementById('game1-status-message');
            const startButton = document.getElementById('game1-start-button');
            
            // åˆæœŸçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            game1Score = 0;
            game1TimeLeft = TARGET_TIME;
            scoreElement.textContent = 0;
            timerElement.textContent = TARGET_TIME.toFixed(1);
            targetElement.classList.remove('active');
            statusMessageElement.textContent = 'æº–å‚™å®Œäº†ã€‚ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
            startButton.textContent = 'ã‚²ãƒ¼ãƒ é–‹å§‹';
            startButton.style.display = 'block';
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š
            targetElement.onclick = handleGame1TargetClick;
            startButton.onclick = startGame1;

            function handleGame1TargetClick() {
                if (!game1IsPlaying) return;
                game1Score++;
                scoreElement.textContent = game1Score;
            }

            function startGame1() {
                if (game1IsPlaying) return;
                game1IsPlaying = true;
                game1Score = 0;
                game1TimeLeft = TARGET_TIME;
                scoreElement.textContent = 0;
                statusMessageElement.textContent = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¾ãã‚Œï¼';
                startButton.style.display = 'none';
                targetElement.classList.add('active'); 

                game1TimerInterval = setInterval(() => {
                    game1TimeLeft = Math.max(0, game1TimeLeft - 0.1);
                    timerElement.textContent = game1TimeLeft.toFixed(1);

                    if (game1TimeLeft <= 0) {
                        clearInterval(game1TimerInterval);
                        endGame1();
                    }
                }, 100);
            }

            function endGame1() {
                game1IsPlaying = false;
                targetElement.classList.remove('active');
                startButton.textContent = 'ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤';
                startButton.style.display = 'block';
                statusMessageElement.textContent = `ã‚²ãƒ¼ãƒ çµ‚äº†ï¼æœ€çµ‚ã‚¹ã‚³ã‚¢: ${game1Score}ç‚¹ã€‚`;
                
                // ã‚¹ã‚³ã‚¢é€ä¿¡
                sendScoreToFirebase(GAMES[0].collection, game1Score, statusMessageElement);
            }
        }
        
        // --- 7. ã‚¹ã‚³ã‚¢é€ä¿¡ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º ---

        async function sendScoreToFirebase(collectionName, finalScore, statusElement) {
            if (finalScore <= 0 || !auth.currentUser) return;

            try {
                const user = auth.currentUser;
                const displayName = user.displayName || user.email.split('@')[0];

                await db.collection(collectionName).add({
                    uid: user.uid,
                    name: displayName,
                    score: finalScore,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                if (statusElement) statusElement.textContent += " ã‚¹ã‚³ã‚¢ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸï¼ğŸ‰";
                loadRankings(); 

            } catch (error) {
                console.error("ã‚¹ã‚³ã‚¢é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                if (statusElement) statusElement.textContent += " (ã‚¹ã‚³ã‚¢ç™»éŒ²å¤±æ•—)";
            }
        }

        function loadRankings() {
            rankingTitleElement.textContent = activeGameId
                ? `ğŸ† ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° (Game ${activeGameId}: ${GAMES.find(g => g.id === activeGameId).name})`
                : `ğŸ† ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° (Game 1: ${GAMES[0].name})`;

            rankingsElement.innerHTML = '<p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            
            db.collection(currentRankingCollection)
                .orderBy("score", "desc")
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    rankingsElement.innerHTML = '';
                    if (querySnapshot.empty) {
                        rankingsElement.innerHTML = '<p>ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                        return;
                    }

                    let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const isCurrentUser = auth.currentUser && data.uid === auth.currentUser.uid;
                        const displayUsername = data.name || data.uid.substring(0, 6) + '...';
                        
                        const item = document.createElement('div');
                        item.className = 'rank-item';
                        item.style.backgroundColor = isCurrentUser ? '#e8f0fe' : 'transparent';
                        item.innerHTML = `
                            <span>#${rank++} ${displayUsername}${isCurrentUser ? ' (ã‚ãªãŸ)' : ''}</span>
                            <span>${data.score} Points</span>
                        `;
                        rankingsElement.appendChild(item);
                    });
                })
                .catch((error) => {
                    console.error("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                    rankingsElement.innerHTML = '<p style="color:red;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
                });
        }

        // --- 8. åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        document.addEventListener('DOMContentLoaded', () => {
            logoutButton.addEventListener('click', () => auth.signOut());
            googleLoginButton.addEventListener('click', signInWithGoogle);
            registerLoginButton.addEventListener('click', handleEmailAuth);
            backToPortalButton.addEventListener('click', renderPortal);
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleEmailAuth();
                }
            });
            
            // åˆæœŸè¡¨ç¤ºã¯Game 1ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã€activeGameIdã‚’1ã«è¨­å®šã—ã¦ãŠã
            activeGameId = 1;
        });
    </script>
</body>
</html>
